<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Historian</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
    background: #f4f6f8;
    font-family: Helvetica, Arial, sans-serif;
    color: #111;
}

.navbar {
    background: #1f2933;
}

.navbar-brand {
    font-weight: bold;
    letter-spacing: 0.5px;
}

.container {
    margin-top: 1rem;
}

.nav-pills .nav-link {
    color: #444;
}

.nav-pills .nav-link.active {
    background: #2563eb;
    color: #fff;
}

.card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.1);
}

input.search {
    border-radius: 8px;
    border: 1px solid #ccc;
}

table {
    width: 100%;
}

td {
    border: none;
    padding: 10px;
    vertical-align: top;
}

tbody tr:nth-child(odd) {
    background: #fafafa;
}

tbody tr:nth-child(even) {
    background: #f1f5f9;
}

.heart {
    cursor: pointer;
    font-size: 1.2rem;
    margin-right: 8px;
}

.footer {
    text-align: center;
    font-size: 0.8rem;
    color: #555;
    margin: 1rem 0;
}
</style>
</head>

<body>

<nav class="navbar navbar-dark">
  <div class="container">
    <span class="navbar-brand">Historian<i>Web</i></span>
    <span id="today" class="text-white"></span>
  </div>
</nav>

<div class="container">
  <ul class="nav nav-pills justify-content-center mb-3">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#events">Events</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#births">Births</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#deaths">Deaths</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#holidays">Holidays</a></li>
  </ul>

  <div class="tab-content">
    <div id="events" class="tab-pane fade show active card p-3"></div>
    <div id="births" class="tab-pane fade card p-3"></div>
    <div id="deaths" class="tab-pane fade card p-3"></div>
    <div id="holidays" class="tab-pane fade card p-3"></div>
  </div>
</div>

<div class="footer">Sage India</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const STORAGE_KEY = 'historian_daily_data';
const FAVORITES_KEY = 'historian_favorites';

const today = new Date();
const dateKey = today.toISOString().split('T')[0];
document.getElementById('today').textContent =
  today.toLocaleDateString(undefined, { month:'long', day:'numeric' });

const favorites = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');

function isFav(text) {
  return favorites.includes(text);
}

function toggleFav(text) {
  const i = favorites.indexOf(text);
  if (i === -1) favorites.push(text);
  else favorites.splice(i, 1);
  localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites));
  location.reload();
}

function renderSection(id, list) {
  const el = document.getElementById(id);
  el.innerHTML = `
    <input class="form-control search mb-2" placeholder="Search">
    <table><tbody>
      ${list.map(item => `
        <tr>
          <td>
            <span class="heart" onclick="toggleFav('${item.replace(/'/g,"\\'")}')">
              ${isFav(item) ? '❤️' : '♡'}
            </span>
            ${item}
          </td>
        </tr>
      `).join('')}
    </tbody></table>
  `;

  const input = el.querySelector('.search');
  const rows = el.querySelectorAll('tbody tr');

  input.addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    rows.forEach(r => {
      r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });
}

function parseWikipedia(html) {
  const doc = new DOMParser().parseFromString(html, 'text/html');

  function extract(id) {
    const out = [];
    const h2 = doc.querySelector(`h2#${id}`);
    if (!h2) return out;

    let el = h2.parentElement.nextElementSibling;
    while (el && !el.classList.contains('mw-heading2')) {
      if (el.tagName === 'UL') {
        el.querySelectorAll(':scope > li').forEach(li => {
          if (li.querySelector('ul')) return;
          li.querySelectorAll('sup').forEach(s => s.remove());
          li.querySelectorAll('a').forEach(a => a.replaceWith(a.textContent));
          out.push(li.textContent.trim());
        });
      }
      el = el.nextElementSibling;
    }
    return out;
  }

  return {
    events: extract('Events'),
    births: extract('Births'),
    deaths: extract('Deaths'),
    holidays: extract('Holidays_and_observances')
  };
}

(async function init() {
  let cached = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null');

  if (cached && cached.date === dateKey) {
    renderSection('events', cached.data.events);
    renderSection('births', cached.data.births);
    renderSection('deaths', cached.data.deaths);
    renderSection('holidays', cached.data.holidays);
    return;
  }

  const page = today.toLocaleString('default',{month:'long'}) + '_' + today.getDate();
  const url = `https://en.wikipedia.org/w/api.php?action=parse&format=json&prop=text&page=${page}&origin=*`;

  const res = await fetch(url);
  const json = await res.json();
  const parsed = parseWikipedia(json.parse.text['*']);

  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    date: dateKey,
    data: parsed
  }));

  renderSection('events', parsed.events);
  renderSection('births', parsed.births);
  renderSection('deaths', parsed.deaths);
  renderSection('holidays', parsed.holidays);
})();
</script>

</body>
</html>
