<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HistorianWeb</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root {
  --bg: #f4f6f8;
  --text: #111;
  --card: #ffffff;
}
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0f172a;
    --text: #e5e7eb;
    --card: #020617;
  }
}
body {
  background: var(--bg);
  color: var(--text);
  font-family: Helvetica, Arial, sans-serif;
}
.card {
  background: var(--card);
  border-radius: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,.2);
}
.heart { cursor:pointer; font-size:1.2rem; margin-right:6px }
.navbar-brand span { font-style: italic; font-family: Arial }
</style>
</head>

<body>

<nav class="navbar navbar-dark bg-dark px-3">
  <a class="navbar-brand">Historian<span>Web</span></a>
  <span id="today" class="text-white"></span>
</nav>

<ul class="nav nav-pills justify-content-around mt-2">
  <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#events">Events</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#births">Births</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#deaths">Deaths</a></li>
  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#holidays">Holidays</a></li>
</ul>

<main class="container-fluid mt-3">
  <div class="tab-content">
    <div id="events" class="tab-pane fade show active card p-3"></div>
    <div id="births" class="tab-pane fade card p-3"></div>
    <div id="deaths" class="tab-pane fade card p-3"></div>
    <div id="holidays" class="tab-pane fade card p-3"></div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ================= PWA INLINE ================= */

const manifest = {
  name: "HistorianWeb",
  short_name: "Historian",
  start_url: ".",
  display: "standalone",
  background_color: "#0f172a",
  theme_color: "#2563eb",
  icons: [{
    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='80'>ðŸ“œ</text></svg>",
    sizes: "192x192",
    type: "image/svg+xml"
  }]
};

const manifestBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
document.head.insertAdjacentHTML(
  'beforeend',
  `<link rel="manifest" href="${URL.createObjectURL(manifestBlob)}">`
);

const swCode = `
const CACHE='historian-cache';
self.addEventListener('install',e=>{
  e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
});
self.addEventListener('fetch',e=>{
  e.respondWith(
    caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
      const copy=res.clone();
      caches.open(CACHE).then(c=>c.put(e.request,copy));
      return res;
    }))
  );
});
`;

if ('serviceWorker' in navigator) {
  const swBlob = new Blob([swCode], {type:'text/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(swBlob));
}

/* ================= APP LOGIC ================= */

const DATA_KEY='historian_data';
const FAV_KEY='historian_favs';
const today=new Date();
document.getElementById('today').textContent =
  today.toLocaleDateString(undefined,{month:'long',day:'numeric'});

let favs=JSON.parse(localStorage.getItem(FAV_KEY)||'[]');
let lastData=null;

function isFav(t){return favs.includes(t)}
function toggleFav(t){
  favs=isFav(t)?favs.filter(x=>x!==t):[...favs,t];
  localStorage.setItem(FAV_KEY,JSON.stringify(favs));
  renderAll(lastData);
}

function render(id,list){
  const el=document.getElementById(id);
  el.innerHTML=`<input class="form-control mb-2" placeholder="Search">
  <table class="table"><tbody>
  ${list.map(x=>`<tr><td>
    <span class="heart" data-t="${x}">${isFav(x)?'ðŸ©µ':'â™¡'}</span>${x}
  </td></tr>`).join('')}
  </tbody></table>`;
  el.querySelectorAll('.heart').forEach(h=>h.onclick=()=>toggleFav(h.dataset.t));
}

function parseWiki(html){
  const doc=new DOMParser().parseFromString(html,'text/html');
  const grab=id=>{
    const out=[];
    const h2=doc.getElementById(id);
    if(!h2)return out;
    let el=h2.parentElement.nextElementSibling;
    while(el&&!el.classList.contains('mw-heading2')){
      if(el.tagName==='UL')
        el.querySelectorAll(':scope>li').forEach(li=>{
          if(!li.querySelector('ul')){
            li.querySelectorAll('sup,a').forEach(x=>x.replaceWith(x.textContent));
            out.push(li.textContent.trim());
          }
        });
      el=el.nextElementSibling;
    }
    return out;
  };
  return {
    events:grab('Events'),
    births:grab('Births'),
    deaths:grab('Deaths'),
    holidays:grab('Holidays_and_observances')
  };
}

async function init(){
  const cache=JSON.parse(localStorage.getItem(DATA_KEY)||'null');
  if(cache&&cache.date===today.toDateString()) lastData=cache.data;
  else{
    const page=`${today.toLocaleString('default',{month:'long'})}_${today.getDate()}`;
    const r=await fetch(`https://en.wikipedia.org/w/api.php?action=parse&format=json&prop=text&page=${page}&origin=*`);
    const j=await r.json();
    lastData=parseWiki(j.parse.text['*']);
    localStorage.setItem(DATA_KEY,JSON.stringify({date:today.toDateString(),data:lastData}));
  }
  renderAll(lastData);
}

function renderAll(d){
  render('events',d.events);
  render('births',d.births);
  render('deaths',d.deaths);
  render('holidays',d.holidays);
}

init();

/* ================= SWIPE NAV ================= */
let xStart=null;
document.addEventListener('touchstart',e=>xStart=e.touches[0].clientX);
document.addEventListener('touchend',e=>{
  if(!xStart)return;
  const dx=e.changedTouches[0].clientX-xStart;
  if(Math.abs(dx)>50){
    const tabs=[...document.querySelectorAll('.nav-link')];
    const i=tabs.findIndex(t=>t.classList.contains('active'));
    const next=tabs[i+(dx<0?1:-1)];
    if(next) next.click();
  }
  xStart=null;
});
</script>
</body>
</html>
